name: fetch-test

on:
  workflow_dispatch:

env:
  YAML_FILE: drivers/staging/hikey9xx/phy-hi3670-usb3.yaml

jobs:
  read-config:
    name: Read configuration
    runs-on: ubuntu-20.04
    outputs:
      config: ${{ steps.read.outputs.config }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.sha }}

      - name: Read configuration from file
        id: read
        shell: python
        run: |
          import json
          import yaml

          with open('${{ env.YAML_FILE }}') as f:
            yaml_content = yaml.safe_load(f)

          print(json.dumps(yaml_content, indent=2))

  read-config-api:
    name: Read configuration using GitHub API
    runs-on: ubuntu-20.04
    outputs:
      config: ${{ steps.read.outputs.config }}

    steps:
      - name: Read configuration from file
        id: read
        shell: python
        run: |
          import base64
          import json
          import os
          import yaml
          import requests
          from requests.models import HTTPBasicAuth

          github_api_url = os.environ.get("GITHUB_API_URL")

          url = (
            github_api_url
            + "/repos/${{ github.repository }}"
            + "/contents/${{ env.YAML_FILE }}?ref=${{ github.ref }}"
          )

          headers = { "authorization": "Bearer ${{ secrets.GITHUB_TOKEN }}" }
          res = requests.get(url, headers=headers)

          body = json.loads(res.content)
          yaml_content = yaml.safe_load(base64.b64decode(body["content"]))

          print(json.dumps(yaml_content, indent=2))

  read-config-action:
    name: Read configuration using Action
    runs-on: ubuntu-20.04
    outputs:
      config: ${{ steps.parse.outputs.config }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          repository: ismaelgonval/actions-sandbox
          ref: master
          token: ${{ secrets.GH_TOKEN_READER }}

      - name: Get content
        id: read
        uses: ./actions/get-content
        with:
          repository: ${{ github.repository }}
          file: ${{ env.YAML_FILE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Read configuration from file
        id: parse
        shell: python
        run: |
          import json
          import yaml

          yaml_content = yaml.safe_load("${{ steps.read.outputs.content }}")

          print(json.dumps(yaml_content, indent=2))
